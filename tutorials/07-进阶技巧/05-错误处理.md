# 模块 5: 错误处理

> 实现健壮的错误处理

## 统一错误处理

```javascript
// 错误类型定义
class AppError extends Error {
  constructor(message, statusCode, code) {
    super(message);
    this.statusCode = statusCode;
    this.code = code;
    this.isOperational = true;
  }
}

class ValidationError extends AppError {
  constructor(message, field) {
    super(message, 400, 'VALIDATION_ERROR');
    this.field = field;
  }
}

class AuthError extends AppError {
  constructor(message) {
    super(message, 401, 'AUTH_ERROR');
  }
}

// 错误处理器
class ErrorHandler {
  static handle(error) {
    if (error.isOperational) {
      return this.handleOperationalError(error);
    }
    return this.handleProgrammerError(error);
  }
  
  static handleOperationalError(error) {
    const message = this.getUserMessage(error);
    this.showNotification(message, 'error');
    console.error('[Operational Error]', error);
  }
  
  static getUserMessage(error) {
    const messages = {
      'VALIDATION_ERROR': `输入验证失败: ${error.message}`,
      'AUTH_ERROR': '认证失败,请重新登录',
      'NOT_FOUND': '请求的资源不存在'
    };
    return messages[error.code] || '操作失败,请稍后重试';
  }
}

// 全局错误捕获
window.addEventListener('error', (event) => {
  ErrorHandler.handle(event.error);
});

window.addEventListener('unhandledrejection', (event) => {
  ErrorHandler.handle(event.reason);
});
```

## API 请求错误处理

```javascript
class APIClient {
  async request(endpoint, options = {}) {
    let lastError;
    
    for (let attempt = 0; attempt < 3; attempt++) {
      try {
        const response = await Promise.race([
          fetch(url, options),
          this.timeoutPromise(10000)
        ]);
        
        if (!response.ok) {
          throw await this.handleHTTPError(response);
        }
        
        return await response.json();
      } catch (error) {
        lastError = error;
        
        if (!this.shouldRetry(error, attempt)) {
          break;
        }
        
        await this.delay(1000 * (attempt + 1));
      }
    }
    
    throw lastError;
  }
  
  shouldRetry(error, attempt) {
    if (attempt >= 2) return false;
    if (error.message === 'Request timeout') return true;
    if (error.statusCode >= 500) return true;
    return false;
  }
}
```

## 关键要点

1. **错误分类** - 区分可预期和不可预期错误
2. **用户友好** - 显示易懂的错误消息
3. **日志记录** - 记录详细错误信息
4. **重试机制** - 对临时错误进行重试

👉 下一个: [模块 6: 安全最佳实践](./06-安全实践.md)
