# 模块 6: 安全最佳实践

> 遵循安全开发规范

## 输入验证和清理

```javascript
class InputValidator {
  // 清理 HTML,防止 XSS
  static sanitizeHTML(input) {
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#x27;',
      '/': '&#x2F;'
    };
    return input.replace(/[&<>"'/]/g, char => map[char]);
  }
  
  // 验证邮箱
  static isValidEmail(email) {
    const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return regex.test(email);
  }
  
  // 验证密码强度
  static isStrongPassword(password) {
    // 至少8位,包含大小写字母、数字和特殊字符
    const regex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
    return regex.test(password);
  }
  
  // 防止 SQL 注入
  static containsSQLInjection(input) {
    const sqlPatterns = [
      /(\b(SELECT|INSERT|UPDATE|DELETE|DROP|CREATE)\b)/i,
      /(--|\#|\/\*|\*\/)/
    ];
    return sqlPatterns.some(pattern => pattern.test(input));
  }
}

// 使用示例
const username = InputValidator.sanitizeHTML(userInput.username);
const validation = InputValidator.validate(username, {
  required: true,
  minLength: 3,
  maxLength: 20
});
```

## 安全存储敏感信息

```javascript
class SecureStorage {
  constructor() {
    this.memoryStorage = new Map();
  }
  
  // 敏感信息存内存
  setSecure(key, value) {
    this.memoryStorage.set(key, value);
  }
  
  getSecure(key) {
    return this.memoryStorage.get(key);
  }
  
  // 非敏感信息可用 localStorage (加密)
  setLocal(key, value) {
    const encrypted = this.encrypt(JSON.stringify(value));
    localStorage.setItem(key, encrypted);
  }
  
  getLocal(key) {
    const encrypted = localStorage.getItem(key);
    if (!encrypted) return null;
    return JSON.parse(this.decrypt(encrypted));
  }
}

// ✅ 正确做法
storage.setSecure('auth_token', token);  // 令牌存内存
storage.setLocal('preferences', { theme: 'dark' });  // 偏好设置加密存储

// ❌ 错误做法
localStorage.setItem('password', password);  // 永远不要存密码
localStorage.setItem('credit_card', cardNumber);  // 不要存敏感信息
```

## CSP 配置

```html
<!-- HTML 中配置 -->
<meta http-equiv="Content-Security-Policy"
      content="default-src 'self';
               script-src 'self' https://trusted-cdn.com;
               style-src 'self' 'unsafe-inline';
               img-src 'self' data: https:;">
```

```javascript
// Express 中配置
const helmet = require('helmet');

app.use(helmet.contentSecurityPolicy({
  directives: {
    defaultSrc: ["'self'"],
    scriptSrc: ["'self'", "https://trusted-cdn.com"],
    styleSrc: ["'self'", "'unsafe-inline'"],
    imgSrc: ["'self'", "data:", "https:"]
  }
}));
```

## 关键要点

1. **输入验证** - 永远不要信任用户输入
2. **输出编码** - 防止 XSS 攻击
3. **安全存储** - 敏感数据不存 localStorage
4. **CSP** - 配置内容安全策略
5. **HTTPS** - 始终使用加密传输

## 课程总结

通过本课程,你学到了:
- 编写高质量提示词
- 进行系统化代码审查
- 使用高效调试方法
- 应用设计模式
- 实现错误处理
- 遵循安全最佳实践

继续实践这些技巧,你的开发能力将大幅提升!

👉 下一课: [第八课: 高级应用](../08-高级应用.md)
