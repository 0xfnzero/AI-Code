# 第十四课：Claude Code 完整使用指南（工具书）

> 🎯 **学习目标**：系统掌握 Claude Code 的所有功能和最佳实践,作为日常开发的参考手册
>
> 🔥 **2025年1月更新**：包含最新的 CLI 命令、配置方法、MCP 集成详解,以及生产环境实践经验。这是你的 Claude Code 百科全书！

## 📚 本指南使用说明

### 🎯 适合人群

- **新手开发者**：从零开始系统学习 Claude Code
- **进阶开发者**：快速查找特定功能和最佳实践
- **团队负责人**：为团队建立标准化开发流程
- **专业开发者**：深入掌握高级特性和优化技巧

### 📖 如何使用本指南

1. **作为学习教材**：按章节顺序完整阅读
2. **作为参考手册**：需要时快速查找特定主题
3. **作为团队规范**：建立团队开发标准
4. **作为故障排查**：遇到问题时查找解决方案

### 🔖 快速导航

- [安装与配置](#一安装与配置) - 基础环境搭建
- [CLI 命令详解](#二cli-命令详解) - 命令行工具使用
- [配置文件管理](#三配置文件管理) - 项目配置优化
- [MCP 服务器集成](#四mcp-服务器集成) - 扩展功能集成
- [提示词工程](#五提示词工程) - 高效交互技巧
- [文件操作](#六文件操作) - 代码管理技巧
- [Git 工作流](#七git-工作流) - 版本控制集成
- [项目管理](#八项目管理) - 多项目协作
- [性能优化](#九性能优化) - 提升响应速度
- [安全最佳实践](#十安全最佳实践) - 安全开发指南
- [故障排查](#十一故障排查) - 常见问题解决
- [生产环境实践](#十二生产环境实践) - 企业级应用

---

## 一、安装与配置

### 1.1 系统要求

**最低要求：**
- Node.js 18.0.0 或更高版本
- npm 9.0.0 或更高版本
- 5GB 可用磁盘空间
- 稳定的网络连接

**推荐配置：**
- Node.js 20.x LTS（长期支持版本）
- npm 10.x
- 10GB+ 可用磁盘空间
- 高速网络连接（API 调用需要）

**支持的操作系统：**
- macOS 12.0 (Monterey) 及以上
- Windows 10/11（64位）
- Linux（Ubuntu 20.04+, Debian 11+, Fedora 36+）

### 1.2 安装方式

#### 方法一：NPM 全局安装（推荐）

```bash
# 安装最新版本
npm install -g @anthropic-ai/claude-code

# 验证安装
claude --version

# 查看帮助
claude --help
```

#### 方法二：NPX 临时运行

```bash
# 不安装,直接运行最新版本
npx @anthropic-ai/claude-code

# 指定版本
npx @anthropic-ai/claude-code@1.2.3
```

#### 方法三：从源代码安装（开发者）

```bash
# 克隆仓库
git clone https://github.com/anthropics/claude-code.git
cd claude-code

# 安装依赖
npm install

# 构建
npm run build

# 链接到全局
npm link
```

### 1.3 API 密钥配置

#### 获取 API 密钥

1. 访问 [Anthropic Console](https://console.anthropic.com/)
2. 注册/登录账号
3. 进入 API Keys 页面
4. 创建新的 API Key
5. **立即保存密钥**（只显示一次）

#### 配置方式

**方法一：交互式配置（推荐新手）**

```bash
# 启动配置向导
claude auth login

# 按提示输入 API 密钥
# 密钥会安全保存到 ~/.claude/config.json
```

**方法二：环境变量（推荐团队）**

```bash
# macOS/Linux - 添加到 ~/.bashrc 或 ~/.zshrc
export ANTHROPIC_API_KEY="sk-ant-api03-..."

# Windows PowerShell - 添加到 $PROFILE
$env:ANTHROPIC_API_KEY="sk-ant-api03-..."

# Windows CMD - 临时设置
set ANTHROPIC_API_KEY=sk-ant-api03-...
```

**方法三：配置文件（推荐项目）**

创建 `.env` 文件（不要提交到 Git）：

```bash
ANTHROPIC_API_KEY=sk-ant-api03-...
```

添加到 `.gitignore`：

```
.env
.env.local
```

### 1.4 首次配置

```bash
# 初始化配置
claude init

# 设置默认模型
claude config set model claude-sonnet-4

# 设置默认工作目录
claude config set workdir ~/Projects

# 查看所有配置
claude config list
```

### 1.5 验证安装

```bash
# 检查版本
claude --version

# 检查 API 连接
claude auth status

# 运行测试对话
claude chat "Hello, Claude!"

# 查看可用模型
claude models list
```

---

## 二、CLI 命令详解

### 2.1 基础命令

#### claude chat

**用途**：启动交互式对话会话

```bash
# 基本用法
claude chat

# 从特定目录启动
claude chat --dir /path/to/project

# 使用特定模型
claude chat --model claude-opus-4

# 设置上下文窗口大小
claude chat --context 100000

# 加载项目配置
claude chat --config .claude.json
```

**常用选项：**

| 选项 | 说明 | 示例 |
|------|------|------|
| `--dir, -d` | 工作目录 | `-d ~/project` |
| `--model, -m` | 使用的模型 | `-m claude-opus-4` |
| `--context` | 上下文窗口 | `--context 200000` |
| `--config, -c` | 配置文件 | `-c .claude.json` |
| `--verbose, -v` | 详细输出 | `-v` |
| `--debug` | 调试模式 | `--debug` |

#### claude auth

**用途**：管理 API 密钥和认证

```bash
# 登录（交互式）
claude auth login

# 登出
claude auth logout

# 检查认证状态
claude auth status

# 更新 API 密钥
claude auth set-key sk-ant-api03-...

# 查看当前密钥（部分遮蔽）
claude auth show-key
```

#### claude config

**用途**：管理配置设置

```bash
# 查看所有配置
claude config list

# 设置配置项
claude config set <key> <value>

# 获取配置项
claude config get <key>

# 删除配置项
claude config delete <key>

# 重置所有配置
claude config reset
```

**常用配置项：**

```bash
# 默认模型
claude config set model claude-sonnet-4

# 工作目录
claude config set workdir ~/Projects

# 编辑器
claude config set editor vscode

# 自动保存历史
claude config set saveHistory true

# 最大 token 数
claude config set maxTokens 4096
```

### 2.2 MCP 命令

#### claude mcp add

**用途**：添加 MCP 服务器

```bash
# 基本语法
claude mcp add <name> [options] -- <command> [args...]

# 用户级服务器（全局可用）
claude mcp add filesystem -s user -- npx -y @modelcontextprotocol/server-filesystem ~/Documents

# 项目级服务器（团队共享）
claude mcp add project-tools -s project -- npx -y @your-team/tools

# 带环境变量
claude mcp add github -s user -e GITHUB_TOKEN=ghp_xxx -- npx -y @modelcontextprotocol/server-github

# 本地服务器（当前目录）
claude mcp add local-tool -- node ./mcp-server.js
```

**选项说明：**

| 选项 | 说明 | 值 |
|------|------|-----|
| `-s, --scope` | 作用域 | `local`, `user`, `project` |
| `-e, --env` | 环境变量 | `KEY=value` |
| `--` | 命令分隔符 | 必需 |

#### claude mcp list

```bash
# 查看所有 MCP 服务器
claude mcp list

# 查看特定作用域
claude mcp list --scope user
claude mcp list --scope project

# 详细信息
claude mcp list --verbose
```

#### claude mcp remove

```bash
# 删除服务器
claude mcp remove <name>

# 强制删除（不提示确认）
claude mcp remove <name> --force

# 删除特定作用域的服务器
claude mcp remove <name> --scope user
```

#### claude mcp test

```bash
# 测试 MCP 服务器连接
claude mcp test <name>

# 测试所有服务器
claude mcp test --all

# 详细测试报告
claude mcp test <name> --verbose
```

### 2.3 项目命令

#### claude project init

```bash
# 在当前目录初始化项目
claude project init

# 指定项目类型
claude project init --type web-app
claude project init --type cli-tool
claude project init --type library

# 使用模板
claude project init --template react-typescript
claude project init --template node-express
```

#### claude project info

```bash
# 查看项目信息
claude project info

# JSON 格式输出
claude project info --json

# 包含统计信息
claude project info --stats
```

### 2.4 工具命令

#### claude analyze

```bash
# 分析代码库
claude analyze

# 分析特定文件
claude analyze src/index.ts

# 生成分析报告
claude analyze --report analysis-report.md

# 检查特定问题
claude analyze --check security
claude analyze --check performance
claude analyze --check best-practices
```

#### claude refactor

```bash
# 交互式重构
claude refactor

# 重构特定文件
claude refactor src/legacy-code.js

# 应用特定重构模式
claude refactor --pattern extract-method
claude refactor --pattern rename-variable
```

#### claude test

```bash
# 生成测试
claude test generate

# 为特定文件生成测试
claude test generate src/utils.ts

# 运行测试
claude test run

# 分析测试覆盖率
claude test coverage
```

### 2.5 调试命令

#### claude debug

```bash
# 启用调试模式
claude --debug chat

# 查看日志
claude debug logs

# 实时查看日志
claude debug logs --follow

# 清除日志
claude debug logs --clear
```

#### claude doctor

```bash
# 诊断安装问题
claude doctor

# 修复常见问题
claude doctor --fix

# 详细诊断报告
claude doctor --verbose
```

---

## 三、配置文件管理

### 3.1 全局配置文件

**位置：** `~/.claude/config.json`

**用途：** 用户级全局设置

```json
{
  "apiKey": "sk-ant-api03-...",
  "model": "claude-sonnet-4",
  "maxTokens": 4096,
  "temperature": 1.0,
  "editor": "vscode",
  "saveHistory": true,
  "historyDir": "~/.claude/history",
  "theme": "dark"
}
```

### 3.2 项目配置文件

**位置：** 项目根目录 `.claude.json`

**用途：** 项目特定配置（团队共享）

```json
{
  "name": "my-project",
  "description": "项目描述",
  "version": "1.0.0",
  "model": "claude-sonnet-4",
  "context": {
    "include": [
      "src/**/*.ts",
      "docs/**/*.md",
      "package.json"
    ],
    "exclude": [
      "node_modules/**",
      "dist/**",
      "*.test.ts"
    ]
  },
  "rules": [
    "使用 TypeScript 严格模式",
    "遵循 ESLint 规则",
    "所有函数必须有文档注释"
  ],
  "mcpServers": {
    "filesystem": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-filesystem", "."]
    }
  }
}
```

### 3.3 CLAUDE.md 文件

**位置：** 项目根目录 `CLAUDE.md`

**用途：** 项目上下文和开发规范

```markdown
# 项目名称

## 项目概述
简要描述项目的目的和功能

## 技术栈
- Frontend: React 18 + TypeScript
- Backend: Node.js + Express
- Database: PostgreSQL
- Deployment: Docker + Kubernetes

## 开发规范

### 代码风格
- 使用 Prettier 格式化代码
- 遵循 ESLint 规则
- 使用语义化命名

### 提交规范
- 使用 Conventional Commits
- 格式：`<type>(<scope>): <subject>`
- 类型：feat, fix, docs, style, refactor, test, chore

### 测试要求
- 单元测试覆盖率 > 80%
- 所有 API 必须有集成测试
- 关键路径必须有 E2E 测试

## 项目结构
```
src/
├── components/     # React 组件
├── services/       # 业务逻辑
├── utils/          # 工具函数
├── types/          # TypeScript 类型
└── tests/          # 测试文件
```

## 环境变量
- `DATABASE_URL`: 数据库连接字符串
- `API_KEY`: 第三方 API 密钥
- `PORT`: 服务器端口（默认 3000）

## 常用命令
- `npm run dev`: 启动开发服务器
- `npm run build`: 构建生产版本
- `npm test`: 运行测试
- `npm run lint`: 代码检查

## 注意事项
- 不要提交 `.env` 文件
- 所有 API 密钥必须通过环境变量配置
- 提交前必须运行测试和 lint
```

### 3.4 环境特定配置

#### 开发环境 `.claude.dev.json`

```json
{
  "model": "claude-sonnet-4",
  "context": {
    "include": ["src/**", "tests/**"]
  },
  "debug": true,
  "verbose": true
}
```

#### 生产环境 `.claude.prod.json`

```json
{
  "model": "claude-opus-4",
  "maxTokens": 8192,
  "context": {
    "include": ["src/**"],
    "exclude": ["**/*.test.*", "**/__tests__/**"]
  },
  "debug": false
}
```

#### 切换配置

```bash
# 使用开发配置
claude chat --config .claude.dev.json

# 使用生产配置
claude chat --config .claude.prod.json

# 环境变量控制
export CLAUDE_CONFIG=.claude.dev.json
claude chat
```

---

## 四、MCP 服务器集成

### 4.1 MCP 架构概述

**MCP（Model Context Protocol）** 是 Anthropic 推出的开源协议,允许 AI 助手连接外部工具和数据源。

**架构图：**

```
┌────────────────────────┐
│    Claude Code CLI     │
│    (MCP Client)        │
└───────────┬────────────┘
            │ MCP Protocol
            │
    ┌───────┴────────┐
    │                │
┌───┴────┐      ┌────┴────┐
│ Server │      │ Server  │
│   A    │      │    B    │
└───┬────┘      └────┬────┘
    │                │
┌───┴────┐      ┌────┴────┐
│  Tool  │      │   API   │
│ Files  │      │ Database│
└────────┘      └─────────┘
```

### 4.2 配置文件详解

**位置：**
- 用户级：`~/.claude.json`
- 项目级：`.mcp.json`

**完整配置示例：**

```json
{
  "mcpServers": {
    "filesystem": {
      "type": "stdio",
      "command": "npx",
      "args": [
        "-y",
        "@modelcontextprotocol/server-filesystem",
        "~/Documents",
        "~/Projects"
      ],
      "env": {
        "NODE_ENV": "production"
      }
    },
    "github": {
      "type": "stdio",
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-github"],
      "env": {
        "GITHUB_TOKEN": "${GITHUB_TOKEN}"
      }
    },
    "postgres": {
      "type": "stdio",
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-postgres"],
      "env": {
        "DATABASE_URL": "${DATABASE_URL}"
      }
    }
  }
}
```

### 4.3 核心 MCP 服务器

#### 1. 文件系统服务器

**功能**：读写文件、目录操作

```bash
claude mcp add filesystem -s user -- npx -y @modelcontextprotocol/server-filesystem ~/Documents ~/Projects
```

**使用示例：**
```
你：读取 ~/Projects/app/src/index.ts 并添加类型注解

Claude：[使用 filesystem MCP]
已读取文件，正在添加类型注解...
```

#### 2. GitHub 服务器

**功能**：管理 issues、PRs、仓库

```bash
claude mcp add github -s user -e GITHUB_TOKEN=ghp_xxx -- npx -y @modelcontextprotocol/server-github
```

**使用示例：**
```
你：创建一个 PR 合并 feature 分支到 main

Claude：[使用 github MCP]
已创建 PR #123: "Add new feature"
审查者：@reviewer
标签：feature, ready-for-review
```

#### 3. 数据库服务器

**功能**：查询、分析数据库

```bash
claude mcp add postgres -s user -e DATABASE_URL=postgresql://... -- npx -y @modelcontextprotocol/server-postgres
```

**使用示例：**
```
你：查询最近 7 天的用户注册趋势

Claude：[使用 postgres MCP]
SELECT DATE(created_at), COUNT(*)
FROM users
WHERE created_at >= NOW() - INTERVAL '7 days'
GROUP BY DATE(created_at);

[显示图表和分析]
```

#### 4. Web 搜索服务器

**功能**：搜索最新信息

```bash
claude mcp add search -s user -e BRAVE_API_KEY=xxx -- npx -y @modelcontextprotocol/server-brave-search
```

#### 5. Puppeteer 服务器

**功能**：浏览器自动化、截图

```bash
claude mcp add puppeteer -s user -- npx -y @modelcontextprotocol/server-puppeteer
```

### 4.4 自定义 MCP 服务器

**创建自定义服务器：**

```javascript
// my-mcp-server.js
import { Server } from '@modelcontextprotocol/sdk';

const server = new Server({
  name: 'my-custom-server',
  version: '1.0.0',
});

// 定义工具
server.setRequestHandler('tools/list', async () => {
  return {
    tools: [{
      name: 'process_text',
      description: '处理文本：大写、小写、反转',
      inputSchema: {
        type: 'object',
        properties: {
          text: { type: 'string' },
          operation: {
            type: 'string',
            enum: ['uppercase', 'lowercase', 'reverse']
          }
        },
        required: ['text', 'operation']
      }
    }]
  };
});

// 实现工具逻辑
server.setRequestHandler('tools/call', async (request) => {
  const { name, arguments: args } = request.params;

  if (name === 'process_text') {
    const { text, operation } = args;
    let result;

    switch (operation) {
      case 'uppercase':
        result = text.toUpperCase();
        break;
      case 'lowercase':
        result = text.toLowerCase();
        break;
      case 'reverse':
        result = text.split('').reverse().join('');
        break;
    }

    return {
      content: [{ type: 'text', text: result }]
    };
  }
});

server.start();
```

**添加自定义服务器：**

```bash
# 安装依赖
npm install @modelcontextprotocol/sdk

# 添加服务器
claude mcp add my-server -- node /path/to/my-mcp-server.js
```

---

## 五、提示词工程

### 5.1 提示词基本原则

#### 1. 具体明确

```
❌ 坏例子：
"帮我改进这个代码"

✅ 好例子：
"重构 src/utils/auth.ts 中的 login 函数，要求：
1. 添加输入验证
2. 改进错误处理
3. 添加 JSDoc 注释
4. 使用 async/await 替代 Promise"
```

#### 2. 提供上下文

```
❌ 坏例子：
"添加一个按钮"

✅ 好例子：
"在 LoginPage 组件（src/pages/Login.tsx）中添加一个'忘记密码'按钮：
- 位置：登录按钮下方
- 样式：遵循现有的 Tailwind CSS 设计系统
- 点击后跳转到 /forgot-password 路由
- 添加对应的单元测试"
```

#### 3. 分步骤说明

```
❌ 坏例子：
"创建一个完整的用户管理系统"

✅ 好例子：
"创建用户管理系统，按以下步骤：

步骤 1：数据模型
- 设计 User 实体（id, email, name, role, created_at）
- 创建 TypeScript 接口

步骤 2：API 路由
- POST /api/users - 创建用户
- GET /api/users - 列出用户
- GET /api/users/:id - 获取用户详情
- PUT /api/users/:id - 更新用户
- DELETE /api/users/:id - 删除用户

步骤 3：前端组件
- UserList - 用户列表
- UserForm - 用户表单
- UserDetail - 用户详情

步骤 4：测试
- API 集成测试
- 组件单元测试"
```

### 5.2 高级提示词技巧

#### 1. 角色设定

```
你是一位资深的 TypeScript 后端工程师，专注于：
- 类型安全
- 性能优化
- 安全最佳实践
- RESTful API 设计

请帮我设计一个高性能的用户认证 API...
```

#### 2. 思维链（Chain of Thought）

```
在实现这个功能前，请：

1. 分析需求和边界条件
2. 设计数据结构和算法
3. 考虑性能和安全问题
4. 提出实现方案
5. 编写代码

然后逐步执行。
```

#### 3. 约束条件

```
实现购物车功能，要求：

必须满足：
- 线程安全（多用户并发）
- 数据一致性
- 性能（< 100ms 响应）

不能使用：
- 全局变量
- 同步 I/O
- 废弃的 API

推荐使用：
- Redis 缓存
- 数据库事务
- 异步操作
```

#### 4. 示例引用

```
参考 src/services/OrderService.ts 的实现风格：
- 使用依赖注入
- 错误处理模式
- 日志记录方式

创建一个类似的 PaymentService...
```

### 5.3 提示词模板库

#### 功能开发模板

```
实现 [功能名称]

需求：
[详细需求描述]

技术栈：
- [技术1]
- [技术2]

文件位置：
[文件路径]

要求：
1. [要求1]
2. [要求2]

验收标准：
- [ ] [标准1]
- [ ] [标准2]

参考实现：
[相关代码文件]
```

#### 代码审查模板

```
请审查以下代码：

文件：[文件路径]

关注点：
1. 代码质量
2. 性能问题
3. 安全漏洞
4. 最佳实践
5. 测试覆盖

提供：
- 问题列表
- 改进建议
- 重构代码
```

#### Bug 修复模板

```
修复 Bug

问题描述：
[详细描述问题]

复现步骤：
1. [步骤1]
2. [步骤2]

预期行为：
[应该如何工作]

实际行为：
[实际发生了什么]

相关文件：
[可能相关的文件]

错误日志：
```
[粘贴错误信息]
```

请：
1. 分析问题根因
2. 提供修复方案
3. 实现修复
4. 添加测试防止回归
```

#### 性能优化模板

```
优化性能

目标：
[具体性能目标，如响应时间 < 100ms]

当前性能：
[当前指标]

瓶颈分析：
[已知的性能瓶颈]

优化范围：
[需要优化的代码/模块]

要求：
1. 分析性能瓶颈
2. 提供优化方案
3. 实施优化
4. 测试验证

约束：
- 不改变现有 API
- 保持代码可读性
- 添加性能测试
```

---

## 六、文件操作

### 6.1 读取文件

```
# 基本读取
读取 src/index.ts

# 读取多个文件
读取以下文件：
- src/index.ts
- src/utils.ts
- src/types.ts

# 读取并分析
读取 src/api/users.ts 并分析：
1. API 端点
2. 数据验证
3. 错误处理
4. 潜在的安全问题
```

### 6.2 写入文件

```
# 创建新文件
创建 src/services/EmailService.ts，实现邮件发送功能

# 修改现有文件
修改 src/config/database.ts，添加 Redis 配置

# 批量创建
创建以下文件：
1. src/models/User.ts - 用户模型
2. src/models/Post.ts - 文章模型
3. src/models/Comment.ts - 评论模型
```

### 6.3 搜索和替换

```
# 全局搜索
在项目中搜索所有使用 console.log 的地方

# 搜索并替换
将所有 var 声明替换为 const/let

# 正则搜索
搜索所有未使用的导入语句（正则：^import .* from .* that is never used）

# 重命名
重命名函数 getUserById 为 fetchUserById（所有引用）
```

### 6.4 代码重构

```
# 提取函数
从 src/components/UserProfile.tsx 的 render 方法中提取以下逻辑为独立函数：
- 用户头像渲染
- 用户信息显示
- 操作按钮组

# 提取组件
将 src/pages/Dashboard.tsx 中的统计卡片提取为 StatsCard 组件

# 重构类
将 src/services/PaymentService.ts 重构为：
1. 提取接口 IPaymentService
2. 分离支付网关逻辑为 PaymentGateway
3. 使用依赖注入
```

### 6.5 批量操作

```
# 批量重命名
重命名 src/components/ 目录下所有组件文件：
- 从 kebab-case.tsx 改为 PascalCase.tsx
- 更新所有导入路径

# 批量添加
为 src/api/ 目录下所有文件添加：
1. 错误处理中间件
2. 请求日志
3. 响应时间统计

# 批量格式化
使用 Prettier 格式化 src/ 目录下所有 TypeScript 文件
```

---

## 七、Git 工作流

### 7.1 基础 Git 操作

```
# 查看状态
显示当前 git 状态

# 查看差异
显示未暂存的更改

# 暂存更改
暂存所有更改

# 提交
创建提交，消息："feat: add user authentication"

# 推送
推送到远程仓库
```

### 7.2 分支管理

```
# 创建分支
创建并切换到新分支 feature/user-profile

# 合并分支
合并 feature/user-profile 到 main

# 解决冲突
帮我解决合并冲突：
1. 分析冲突
2. 提供解决方案
3. 保留正确的代码

# 删除分支
删除已合并的 feature/user-profile 分支
```

### 7.3 提交规范

#### Conventional Commits

```
<type>(<scope>): <subject>

<body>

<footer>
```

**类型（type）：**

- `feat`: 新功能
- `fix`: Bug 修复
- `docs`: 文档更新
- `style`: 代码格式（不影响代码运行）
- `refactor`: 重构
- `perf`: 性能优化
- `test`: 测试
- `chore`: 构建/工具链

**示例：**

```bash
feat(auth): add JWT token refresh mechanism

- Implement refresh token rotation
- Add token expiration check
- Update API documentation

Closes #123
```

### 7.4 Pull Request 流程

```
创建 Pull Request，包含：

标题：
[简洁描述，如 "Add user authentication system"]

描述：
## 变更概述
[描述主要变更]

## 变更类型
- [ ] 新功能
- [ ] Bug 修复
- [ ] 重构
- [ ] 文档

## 测试
- [ ] 单元测试
- [ ] 集成测试
- [ ] 手动测试

## 检查清单
- [ ] 代码通过 lint
- [ ] 测试全部通过
- [ ] 更新了文档
- [ ] 没有破坏性变更

## 截图
[如果有 UI 变更]

## 相关 Issue
Closes #123
```

### 7.5 代码审查

```
审查 Pull Request #123

关注点：
1. 代码质量
   - 命名规范
   - 代码复杂度
   - 重复代码

2. 功能正确性
   - 逻辑正确
   - 边界条件
   - 错误处理

3. 性能
   - 算法效率
   - 数据库查询
   - 缓存使用

4. 安全
   - 输入验证
   - 认证授权
   - 敏感数据

5. 测试
   - 测试覆盖率
   - 测试质量
   - 边界测试

提供：
- 具体的改进建议
- 代码示例
- 批准/请求修改
```

---

## 八、项目管理

### 8.1 项目初始化

```
初始化新项目：

项目类型：Web 应用
技术栈：
- Frontend: React 18 + TypeScript + Vite
- Backend: Node.js + Express + TypeScript
- Database: PostgreSQL
- Styling: Tailwind CSS

创建：
1. 项目结构
2. 配置文件
3. README.md
4. .gitignore
5. 基础依赖
6. 开发脚本
```

### 8.2 项目结构

**推荐结构：**

```
project-root/
├── .claude.json              # Claude Code 配置
├── CLAUDE.md                 # 项目上下文
├── .mcp.json                 # MCP 服务器配置
├── .env.example              # 环境变量模板
├── .gitignore
├── package.json
├── tsconfig.json
├── README.md
├── docs/                     # 文档
│   ├── API.md
│   ├── ARCHITECTURE.md
│   └── CONTRIBUTING.md
├── src/
│   ├── components/           # 组件
│   ├── services/             # 业务逻辑
│   ├── utils/                # 工具函数
│   ├── types/                # TypeScript 类型
│   ├── hooks/                # React Hooks
│   ├── config/               # 配置
│   └── tests/                # 测试
└── scripts/                  # 脚本
```

### 8.3 文档管理

#### API 文档

```
生成 API 文档：

分析 src/api/ 目录下的所有路由
创建 docs/API.md，包含：

对于每个端点：
- HTTP 方法和路径
- 请求参数
- 请求体示例
- 响应示例
- 错误码
- 使用示例（curl）

格式：OpenAPI 3.0 风格
```

#### 架构文档

```
生成架构文档：

分析项目结构
创建 docs/ARCHITECTURE.md，包含：

1. 系统概述
2. 架构图
3. 技术栈
4. 数据流
5. 核心模块
6. 设计决策
7. 性能考虑
8. 安全措施
```

### 8.4 依赖管理

```
# 分析依赖
分析 package.json，检查：
1. 过时的依赖
2. 安全漏洞
3. 未使用的依赖
4. 重复依赖

# 更新依赖
安全更新所有依赖，避免破坏性变更

# 添加依赖
添加 axios 并配置拦截器

# 移除依赖
移除 lodash 并使用原生 JavaScript 替代
```

### 8.5 脚本管理

**package.json scripts：**

```json
{
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview",
    "test": "vitest",
    "test:coverage": "vitest --coverage",
    "lint": "eslint . --ext ts,tsx",
    "lint:fix": "eslint . --ext ts,tsx --fix",
    "format": "prettier --write \"src/**/*.{ts,tsx}\"",
    "type-check": "tsc --noEmit",
    "prepare": "husky install"
  }
}
```

---

## 九、性能优化

### 9.1 代码优化

```
优化性能

文件：src/components/LargeList.tsx

问题：
- 渲染 10000 条数据时卡顿
- 每次状态更新都重新渲染整个列表

要求：
1. 实现虚拟滚动
2. 使用 React.memo 优化
3. 实现增量加载
4. 添加性能监控

目标：
- 初始渲染 < 100ms
- 滚动流畅（60fps）
- 内存占用 < 100MB
```

### 9.2 构建优化

```
优化构建性能

当前问题：
- 构建时间 > 5 分钟
- Bundle 体积 > 5MB
- 首屏加载 > 3s

优化项：
1. 代码分割
2. Tree shaking
3. 压缩优化
4. CDN 资源
5. 懒加载

配置文件：vite.config.ts
```

### 9.3 数据库优化

```
优化数据库查询

问题查询：
```sql
SELECT * FROM users
WHERE created_at > '2024-01-01'
ORDER BY created_at DESC
```

问题：
- 全表扫描
- 查询时间 > 5s
- 返回不必要的列

要求：
1. 添加索引
2. 优化查询
3. 分页实现
4. 缓存策略

目标：< 100ms
```

### 9.4 API 优化

```
优化 API 性能

端点：GET /api/users

当前问题：
- 响应时间 > 2s
- N+1 查询问题
- 无缓存

优化方案：
1. 数据库查询优化
2. 添加 Redis 缓存
3. 响应数据压缩
4. 实现 GraphQL（可选）

目标：
- 响应时间 < 200ms
- 支持并发 1000 请求/s
```

### 9.5 性能监控

```
添加性能监控

要求：
1. 前端性能监控
   - FCP, LCP, CLS
   - 路由切换时间
   - API 请求时间

2. 后端性能监控
   - 请求响应时间
   - 数据库查询时间
   - 内存和 CPU 使用

3. 告警机制
   - 响应时间超过阈值
   - 错误率超过 1%
   - 资源使用异常

工具：
- 前端：Web Vitals
- 后端：Prometheus + Grafana
```

---

## 十、安全最佳实践

### 10.1 输入验证

```
添加输入验证

文件：src/api/users.ts

端点：POST /api/users

验证规则：
1. email
   - 必填
   - 有效邮箱格式
   - 最大长度 255

2. password
   - 必填
   - 最小长度 8
   - 包含大小写字母、数字、特殊字符

3. name
   - 必填
   - 最小长度 2
   - 最大长度 50
   - 只能包含字母、空格、连字符

使用：
- Zod 进行验证
- 返回详细错误信息
- 防止 SQL 注入
```

### 10.2 认证授权

```
实现 JWT 认证

要求：
1. 用户注册/登录
   - 密码加密（bcrypt）
   - JWT token 生成
   - Refresh token 机制

2. 认证中间件
   - Token 验证
   - 权限检查
   - 速率限制

3. 授权
   - 基于角色（RBAC）
   - 资源权限检查

4. 安全措施
   - Token 过期策略
   - CSRF 保护
   - XSS 防护
```

### 10.3 数据安全

```
保护敏感数据

要求：
1. 加密
   - 密码：bcrypt
   - 敏感字段：AES-256
   - 传输：HTTPS/TLS

2. 脱敏
   - 日志中的敏感信息
   - API 响应中的密码
   - 错误消息

3. 访问控制
   - 最小权限原则
   - 审计日志
   - 数据备份

实现位置：
- src/utils/encryption.ts
- src/middleware/sanitize.ts
```

### 10.4 API 安全

```
加固 API 安全

措施：
1. 认证
   - JWT/OAuth 2.0
   - API Key

2. 授权
   - 资源级权限
   - 速率限制

3. 输入验证
   - 参数验证
   - 防注入

4. 输出编码
   - XSS 防护
   - JSON 编码

5. CORS
   - 白名单配置
   - 预检请求

6. 请求限制
   - 速率限制
   - 负载限制
   - 超时设置

实现文件：
- src/middleware/security.ts
- src/config/cors.ts
```

### 10.5 依赖安全

```
检查依赖安全

任务：
1. 扫描漏洞
   npm audit
   npm audit fix

2. 更新依赖
   - 安全补丁
   - 验证更新

3. 供应链安全
   - 验证包签名
   - 使用 lock 文件
   - 审查新依赖

4. 自动化
   - Dependabot
   - Snyk
   - GitHub Security Alerts

生成报告：security-report.md
```

---

## 十一、故障排查

### 11.1 常见错误

#### 错误 1：API 连接失败

**症状：**
```
Error: Could not connect to Anthropic API
```

**原因：**
- API 密钥无效或过期
- 网络连接问题
- API 服务中断

**解决方案：**

```bash
# 1. 检查 API 密钥
claude auth status

# 2. 测试网络连接
curl https://api.anthropic.com/v1/messages

# 3. 更新 API 密钥
claude auth login

# 4. 检查代理设置
echo $HTTPS_PROXY
```

#### 错误 2：MCP 服务器无法启动

**症状：**
```
Error: MCP server 'filesystem' failed to start
```

**原因：**
- 服务器配置错误
- 依赖未安装
- 权限问题

**解决方案：**

```bash
# 1. 测试服务器
claude mcp test filesystem

# 2. 查看日志
claude debug logs --filter mcp

# 3. 重新安装
claude mcp remove filesystem
claude mcp add filesystem -s user -- npx -y @modelcontextprotocol/server-filesystem ~/Documents

# 4. 检查权限
ls -la ~/.claude.json
```

#### 错误 3：上下文窗口溢出

**症状：**
```
Error: Context window exceeded
```

**原因：**
- 包含太多文件
- 文件太大
- 历史对话太长

**解决方案：**

```bash
# 1. 清除历史
/clear

# 2. 限制包含文件
编辑 .claude.json：
{
  "context": {
    "include": ["src/**/*.ts"],
    "exclude": ["**/*.test.ts", "dist/**"]
  }
}

# 3. 使用较大的模型
claude chat --model claude-opus-4

# 4. 分批处理
将大任务拆分为多个小任务
```

### 11.2 性能问题

#### 问题 1：响应慢

**症状：**
- 回复延迟 > 30s
- 频繁超时

**诊断：**

```bash
# 1. 检查网络
ping api.anthropic.com

# 2. 查看详细日志
claude --debug chat

# 3. 检查上下文大小
claude project info --stats

# 4. 监控资源
top
```

**优化：**

```bash
# 1. 减少上下文
限制包含的文件数量

# 2. 使用更快的模型
claude chat --model claude-sonnet-4

# 3. 清除缓存
rm -rf ~/.claude/cache/*

# 4. 配置代理（如果需要）
export HTTPS_PROXY=http://proxy:port
```

#### 问题 2：内存占用高

**症状：**
- 内存使用 > 2GB
- 系统变慢

**解决：**

```bash
# 1. 清除历史
claude history clear

# 2. 限制缓存大小
claude config set cacheSize 100MB

# 3. 重启 Claude
killall claude
claude chat

# 4. 优化配置
减少 maxTokens
减少包含的文件
```

### 11.3 配置问题

#### 问题 1：配置未生效

**检查步骤：**

```bash
# 1. 验证配置文件语法
cat .claude.json | jq .

# 2. 检查配置优先级
# 项目配置 > 用户配置 > 默认配置

# 3. 查看生效的配置
claude config list

# 4. 测试配置
claude chat --config .claude.json --verbose
```

#### 问题 2：环境变量冲突

```bash
# 1. 查看所有环境变量
env | grep CLAUDE
env | grep ANTHROPIC

# 2. 清除冲突变量
unset CLAUDE_API_KEY
unset ANTHROPIC_API_KEY

# 3. 重新设置
export ANTHROPIC_API_KEY=sk-ant-api03-...

# 4. 验证
echo $ANTHROPIC_API_KEY
claude auth status
```

### 11.4 调试技巧

#### 1. 启用调试模式

```bash
# 详细输出
claude --verbose chat

# 调试模式
claude --debug chat

# 同时启用
claude --verbose --debug chat
```

#### 2. 查看日志

```bash
# 实时查看日志
tail -f ~/.claude/logs/claude.log

# 查看错误日志
grep ERROR ~/.claude/logs/claude.log

# 查看最近日志
tail -n 100 ~/.claude/logs/claude.log
```

#### 3. 测试连接

```bash
# 测试 API
claude auth status

# 测试 MCP
claude mcp test --all

# 诊断系统
claude doctor
```

#### 4. 重置配置

```bash
# 备份当前配置
cp ~/.claude.json ~/.claude.json.backup

# 重置配置
claude config reset

# 重新配置
claude init
```

---

## 十二、生产环境实践

### 12.1 CI/CD 集成

#### GitHub Actions

**.github/workflows/claude-review.yml：**

```yaml
name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  code-review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Configure Claude
        run: |
          echo "${{ secrets.ANTHROPIC_API_KEY }}" | claude auth login --stdin

      - name: Run Code Review
        run: |
          claude analyze --format json > review.json

      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = JSON.parse(fs.readFileSync('review.json'));

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Claude Code Review\n\n${review.summary}`
            });
```

#### GitLab CI

**.gitlab-ci.yml：**

```yaml
stages:
  - review
  - test
  - deploy

claude-review:
  stage: review
  image: node:20
  before_script:
    - npm install -g @anthropic-ai/claude-code
    - echo "$ANTHROPIC_API_KEY" | claude auth login --stdin
  script:
    - claude analyze --report review.md
  artifacts:
    reports:
      codequality: review.md
  only:
    - merge_requests
```

### 12.2 Docker 集成

**Dockerfile：**

```dockerfile
FROM node:20-slim

# 安装 Claude Code
RUN npm install -g @anthropic-ai/claude-code

# 设置工作目录
WORKDIR /workspace

# 配置 Claude
ARG ANTHROPIC_API_KEY
ENV ANTHROPIC_API_KEY=$ANTHROPIC_API_KEY

# 复制项目配置
COPY .claude.json /root/.claude/config.json
COPY CLAUDE.md .

# 入口点
ENTRYPOINT ["claude"]
CMD ["chat"]
```

**docker-compose.yml：**

```yaml
version: '3.8'

services:
  claude-code:
    build: .
    volumes:
      - ./:/workspace
      - ~/.claude:/root/.claude
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    stdin_open: true
    tty: true
```

**使用：**

```bash
# 构建镜像
docker build -t claude-code .

# 运行
docker run -it --rm \
  -v $(pwd):/workspace \
  -e ANTHROPIC_API_KEY \
  claude-code

# 使用 docker-compose
docker-compose run claude-code
```

### 12.3 团队协作

#### 团队配置

**项目根目录：.claude.json**

```json
{
  "name": "team-project",
  "version": "1.0.0",
  "model": "claude-sonnet-4",
  "context": {
    "include": [
      "src/**/*.{ts,tsx}",
      "docs/**/*.md",
      "package.json",
      "tsconfig.json"
    ],
    "exclude": [
      "node_modules/**",
      "dist/**",
      "**/*.test.ts"
    ]
  },
  "rules": [
    "使用 TypeScript 严格模式",
    "遵循 Airbnb 代码规范",
    "所有函数必须有 JSDoc 注释",
    "测试覆盖率必须 > 80%",
    "Commit 消息遵循 Conventional Commits"
  ],
  "mcpServers": {
    "filesystem": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-filesystem", "."]
    },
    "github": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-github"],
      "env": {
        "GITHUB_TOKEN": "${GITHUB_TOKEN}"
      }
    }
  }
}
```

#### 环境变量管理

**.env.example：**

```bash
# API Keys
ANTHROPIC_API_KEY=sk-ant-api03-...
GITHUB_TOKEN=ghp_...

# Database
DATABASE_URL=postgresql://user:pass@localhost:5432/db

# Redis
REDIS_URL=redis://localhost:6379

# Application
NODE_ENV=development
PORT=3000
```

**团队文档：CLAUDE.md**

```markdown
# 团队开发指南

## 项目概述
[项目描述]

## 开发流程

### 1. 环境搭建
```bash
# 安装依赖
npm install

# 配置环境变量
cp .env.example .env.local
# 编辑 .env.local 填入你的凭证

# 启动开发服务器
npm run dev
```

### 2. 开发规范

#### 分支命名
- feature/功能名
- fix/bug描述
- refactor/重构描述

#### Commit 规范
遵循 Conventional Commits：
- feat: 新功能
- fix: Bug 修复
- docs: 文档更新
- refactor: 重构

#### 代码审查
- 所有代码必须经过审查
- 至少 1 个审查通过
- CI 检查必须通过

### 3. 使用 Claude Code

#### 启动
```bash
claude chat
```

#### 常用命令
- 实现功能：详细描述需求
- 修复 Bug：提供错误信息和复现步骤
- 代码审查：请求审查特定文件
- 生成测试：为现有代码生成测试

### 4. 最佳实践

#### 提示词技巧
1. 提供充分上下文
2. 明确具体需求
3. 参考现有代码风格
4. 要求测试和文档

#### 文件操作
1. 明确指定文件路径
2. 描述变更原因
3. 要求保持一致性

#### Git 集成
1. 使用语义化提交消息
2. 每个 PR 聚焦单一功能
3. 及时更新文档
```

### 12.4 监控和日志

#### 应用监控

**监控配置：monitoring.ts**

```typescript
import { createLogger } from 'winston';
import { PrometheusExporter } from '@opentelemetry/exporter-prometheus';

// 日志配置
export const logger = createLogger({
  level: 'info',
  format: winston.format.json(),
  transports: [
    new winston.transports.File({
      filename: 'error.log',
      level: 'error'
    }),
    new winston.transports.File({
      filename: 'combined.log'
    }),
  ],
});

// 指标导出
export const metricsExporter = new PrometheusExporter({
  port: 9464,
});

// Claude Code 使用统计
export function trackClaudeUsage(operation: string, duration: number) {
  logger.info('Claude operation', {
    operation,
    duration,
    timestamp: new Date().toISOString(),
  });

  // 记录到 Prometheus
  claudeOperationDuration.record(duration, { operation });
}
```

#### 错误追踪

**集成 Sentry：**

```typescript
import * as Sentry from '@sentry/node';

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 1.0,
});

// 捕获 Claude Code 错误
process.on('uncaughtException', (error) => {
  Sentry.captureException(error);
  logger.error('Uncaught exception', { error });
});
```

### 12.5 性能优化

#### 缓存策略

```typescript
import Redis from 'ioredis';

const redis = new Redis(process.env.REDIS_URL);

// 缓存 Claude 响应
export async function getCachedResponse(
  prompt: string
): Promise<string | null> {
  const cacheKey = `claude:${hash(prompt)}`;
  return await redis.get(cacheKey);
}

export async function cacheResponse(
  prompt: string,
  response: string,
  ttl: number = 3600
): Promise<void> {
  const cacheKey = `claude:${hash(prompt)}`;
  await redis.setex(cacheKey, ttl, response);
}
```

#### 请求队列

```typescript
import Queue from 'bull';

const claudeQueue = new Queue('claude-requests', {
  redis: process.env.REDIS_URL
});

// 处理队列任务
claudeQueue.process(async (job) => {
  const { prompt, options } = job.data;

  // 调用 Claude Code
  const response = await executeClaudeRequest(prompt, options);

  return response;
});

// 添加任务到队列
export async function queueClaudeRequest(
  prompt: string,
  options: any
): Promise<Job> {
  return await claudeQueue.add({
    prompt,
    options
  }, {
    attempts: 3,
    backoff: {
      type: 'exponential',
      delay: 2000
    }
  });
}
```

---

## 十三、附录

### 13.1 快捷键和命令

#### 交互式会话快捷键

| 快捷键 | 功能 |
|--------|------|
| `Ctrl+C` | 中断当前操作 |
| `Ctrl+D` | 退出会话 |
| `↑` / `↓` | 历史命令导航 |
| `Tab` | 自动补全 |
| `Ctrl+L` | 清屏 |

#### 内置命令

| 命令 | 说明 |
|------|------|
| `/help` | 显示帮助 |
| `/clear` | 清除对话历史 |
| `/history` | 查看历史记录 |
| `/save` | 保存当前会话 |
| `/load` | 加载保存的会话 |
| `/context` | 查看当前上下文 |
| `/mcp` | MCP 服务器状态 |
| `/config` | 查看配置 |
| `/exit` | 退出 |

### 13.2 模型选择指南

| 模型 | 用途 | 特点 | 成本 |
|------|------|------|------|
| Claude Opus 4 | 复杂任务 | 最强能力 | 高 |
| Claude Sonnet 4 | 日常开发 | 平衡性能 | 中 |
| Claude Haiku 3 | 简单任务 | 快速响应 | 低 |

**选择建议：**

- **Opus**：架构设计、复杂重构、性能优化
- **Sonnet**：功能开发、代码审查、Bug 修复
- **Haiku**：简单修改、格式化、文档生成

### 13.3 资源链接

**官方资源：**
- [Claude Code 官方文档](https://docs.anthropic.com/claude/docs/claude-code)
- [MCP 协议规范](https://github.com/anthropics/model-context-protocol)
- [Anthropic API 文档](https://docs.anthropic.com/claude/reference)

**社区资源：**
- [GitHub Issues](https://github.com/anthropics/claude-code/issues)
- [Discord 社区](https://discord.gg/anthropic)
- [论坛讨论](https://forum.anthropic.com)

**学习资源：**
- [提示词工程指南](https://docs.anthropic.com/claude/docs/prompt-engineering)
- [最佳实践集](https://docs.anthropic.com/claude/docs/best-practices)
- [示例项目](https://github.com/anthropics/claude-code-examples)

### 13.4 术语表

| 术语 | 说明 |
|------|------|
| **MCP** | Model Context Protocol，模型上下文协议 |
| **Token** | 文本单元，约等于 0.75 个英文单词 |
| **Context Window** | 上下文窗口，模型一次可处理的最大 token 数 |
| **Prompt** | 提示词，发送给 AI 的指令 |
| **Temperature** | 温度参数，控制输出随机性（0-1） |
| **System Prompt** | 系统提示词，定义 AI 行为 |
| **Few-shot** | 少样本学习，提供示例以改进输出 |
| **Fine-tuning** | 微调，使用特定数据训练模型 |

### 13.5 常见问题 FAQ

**Q: Claude Code 是否免费？**
A: Claude Code CLI 工具本身免费，但需要 Anthropic API 密钥，API 调用按使用量计费。

**Q: 如何查看 API 使用量？**
A: 登录 [Anthropic Console](https://console.anthropic.com/) 查看详细的使用统计。

**Q: 支持离线使用吗？**
A: 不支持。Claude Code 需要网络连接来调用 Anthropic API。

**Q: 数据安全吗？**
A: 发送到 API 的数据不会用于训练模型。详见 [隐私政策](https://www.anthropic.com/privacy)。

**Q: 如何升级到最新版本？**
A: 运行 `npm update -g @anthropic-ai/claude-code`

**Q: 支持哪些编程语言？**
A: 支持所有主流编程语言，包括 TypeScript、Python、Java、Go、Rust 等。

**Q: 能否在公司内部使用？**
A: 可以。建议查看 [企业版方案](https://www.anthropic.com/claude/enterprise)。

**Q: MCP 服务器运行在哪里？**
A: MCP 服务器在本地运行，通过进程通信与 Claude Code 交互。

---

## 📚 总结

本指南涵盖了 Claude Code 的：

✅ **基础功能**
- 安装配置
- CLI 命令
- 文件操作

✅ **进阶特性**
- MCP 集成
- 提示词工程
- Git 工作流

✅ **生产实践**
- CI/CD 集成
- 性能优化
- 安全最佳实践

✅ **故障排查**
- 常见错误
- 调试技巧
- 性能优化

### 🎯 下一步

1. **新手**：从[第一课](./01-基础概念.md)开始系统学习
2. **进阶**：查看[第九课：提示词优化](./09-提示词优化技巧.md)
3. **高级**：学习[第十课：AI 子代理系统](./10-AI子代理系统.md)

### 💡 持续学习

- 关注官方更新
- 参与社区讨论
- 分享使用经验
- 贡献最佳实践

---

**本指南会持续更新**，请关注 [GitHub 仓库](https://github.com/0xfnzero/AI-Code-Tutorials) 获取最新内容。

📚 [返回教程目录](../README.md)
