# 模块 4: 前端功能实现

> 使用 JavaScript 让界面充满活力

## 学习目标

完成本模块后,你将能够:
- 实现任务 CRUD 操作
- 使用本地存储进行数据持久化
- 处理表单验证
- 创建动态 UI 交互
- 管理应用状态

## 概述

在本模块中,我们将为 Todo App Pro 添加 JavaScript 功能,使其完全交互。我们将实现任务管理、本地存储和用户交互。

## 1. 任务数据模型

### 创建 Task 类

**client/js/task.js**:
```javascript
/**
 * Task 类
 * 表示单个任务及其所有属性
 */
class Task {
    constructor(title, description = '', dueDate = null, priority = 'medium', category = 'personal') {
        this.id = this.generateId();
        this.title = title;
        this.description = description;
        this.dueDate = dueDate;
        this.priority = priority; // 'low', 'medium', 'high'
        this.category = category;
        this.completed = false;
        this.createdAt = new Date().toISOString();
        this.updatedAt = new Date().toISOString();
    }

    generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    toggleComplete() {
        this.completed = !this.completed;
        this.updatedAt = new Date().toISOString();
    }

    update(updates) {
        Object.assign(this, updates);
        this.updatedAt = new Date().toISOString();
    }

    isOverdue() {
        if (!this.dueDate || this.completed) return false;
        return new Date(this.dueDate) < new Date();
    }

    getFormattedDueDate() {
        if (!this.dueDate) return '无到期日期';
        
        const date = new Date(this.dueDate);
        const today = new Date();
        
        if (date.toDateString() === today.toDateString()) {
            return '今天';
        }
        
        return date.toLocaleDateString('zh-CN');
    }

    static fromJSON(data) {
        const task = new Task(data.title);
        Object.assign(task, data);
        return task;
    }
}
```

## 2. 本地存储管理

**client/js/storage.js**:
```javascript
const StorageManager = {
    STORAGE_KEY: 'todo_app_tasks',

    getTasks() {
        const data = localStorage.getItem(this.STORAGE_KEY);
        return data ? JSON.parse(data).map(t => Task.fromJSON(t)) : [];
    },

    saveTasks(tasks) {
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(tasks));
    },

    addTask(task) {
        const tasks = this.getTasks();
        tasks.push(task);
        this.saveTasks(tasks);
        return task;
    },

    updateTask(id, updates) {
        const tasks = this.getTasks();
        const task = tasks.find(t => t.id === id);
        if (task) {
            task.update(updates);
            this.saveTasks(tasks);
        }
        return task;
    },

    deleteTask(id) {
        let tasks = this.getTasks();
        tasks = tasks.filter(t => t.id !== id);
        this.saveTasks(tasks);
    }
};
```

## 3. UI 管理

**client/js/ui.js**:
```javascript
const UIManager = {
    renderTasks(tasks) {
        const taskList = document.getElementById('taskList');
        taskList.innerHTML = '';

        if (tasks.length === 0) {
            taskList.innerHTML = '<p class="loading">暂无任务</p>';
            return;
        }

        tasks.forEach(task => {
            const taskCard = this.createTaskCard(task);
            taskList.appendChild(taskCard);
        });
    },

    createTaskCard(task) {
        const card = document.createElement('div');
        card.className = `task-card priority-${task.priority} ${task.completed ? 'completed' : ''}`;
        card.dataset.id = task.id;

        card.innerHTML = `
            <div class="task-header">
                <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''}>
                <label class="task-title">${this.escapeHTML(task.title)}</label>
            </div>
            <p class="task-description">${this.escapeHTML(task.description || '')}</p>
            <div class="task-meta">
                <span class="task-category">${task.category}</span>
                <span class="task-priority priority-${task.priority}">${this.getPriorityText(task.priority)}</span>
                <span class="task-date">📅 ${task.getFormattedDueDate()}</span>
            </div>
            <div class="task-actions">
                <button class="btn-icon btn-edit" title="编辑">✏️</button>
                <button class="btn-icon btn-delete" title="删除">🗑️</button>
            </div>
        `;

        return card;
    },

    showModal() {
        document.getElementById('taskModal').classList.add('active');
    },

    hideModal() {
        document.getElementById('taskModal').classList.remove('active');
    },

    escapeHTML(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    },

    getPriorityText(priority) {
        const texts = { low: '低', medium: '中', high: '高' };
        return texts[priority] || priority;
    }
};
```

## 4. 应用主逻辑

**client/js/app.js**:
```javascript
const TodoApp = {
    tasks: [],
    currentFilter: 'all',
    currentSort: 'date',

    init() {
        this.loadTasks();
        this.setupEventListeners();
        this.render();
    },

    loadTasks() {
        this.tasks = StorageManager.getTasks();
    },

    setupEventListeners() {
        // 添加任务按钮
        document.getElementById('addTaskBtn').addEventListener('click', () => {
            UIManager.showModal();
        });

        // 任务表单提交
        document.getElementById('taskForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleTaskSubmit();
        });

        // 任务列表事件委托
        document.getElementById('taskList').addEventListener('click', (e) => {
            const taskCard = e.target.closest('.task-card');
            if (!taskCard) return;

            if (e.target.classList.contains('task-checkbox')) {
                this.toggleTask(taskCard.dataset.id);
            } else if (e.target.classList.contains('btn-delete')) {
                this.deleteTask(taskCard.dataset.id);
            } else if (e.target.classList.contains('btn-edit')) {
                this.editTask(taskCard.dataset.id);
            }
        });

        // 过滤按钮
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                this.setFilter(e.target.dataset.filter);
            });
        });

        // 排序
        document.getElementById('sortSelect').addEventListener('change', (e) => {
            this.currentSort = e.target.value;
            this.render();
        });

        // 搜索
        document.getElementById('searchInput').addEventListener('input', (e) => {
            this.searchTasks(e.target.value);
        });
    },

    handleTaskSubmit() {
        const formData = {
            title: document.getElementById('taskTitle').value,
            description: document.getElementById('taskDescription').value,
            category: document.getElementById('taskCategory').value,
            priority: document.getElementById('taskPriority').value,
            dueDate: document.getElementById('taskDueDate').value
        };

        const task = new Task(
            formData.title,
            formData.description,
            formData.dueDate,
            formData.priority,
            formData.category
        );

        StorageManager.addTask(task);
        this.loadTasks();
        this.render();
        UIManager.hideModal();
        document.getElementById('taskForm').reset();
    },

    toggleTask(id) {
        const task = this.tasks.find(t => t.id === id);
        if (task) {
            task.toggleComplete();
            StorageManager.saveTasks(this.tasks);
            this.render();
        }
    },

    deleteTask(id) {
        if (confirm('确定要删除这个任务吗?')) {
            StorageManager.deleteTask(id);
            this.loadTasks();
            this.render();
        }
    },

    setFilter(filter) {
        this.currentFilter = filter;
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.filter === filter);
        });
        this.render();
    },

    searchTasks(query) {
        const filtered = this.tasks.filter(task => 
            task.title.toLowerCase().includes(query.toLowerCase())
        );
        UIManager.renderTasks(this.sortTasks(filtered));
    },

    sortTasks(tasks) {
        return tasks.sort((a, b) => {
            if (this.currentSort === 'priority') {
                const priorityOrder = { high: 0, medium: 1, low: 2 };
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            } else if (this.currentSort === 'date') {
                return new Date(b.createdAt) - new Date(a.createdAt);
            }
            return a.title.localeCompare(b.title);
        });
    },

    getFilteredTasks() {
        let filtered = this.tasks;

        if (this.currentFilter === 'active') {
            filtered = filtered.filter(t => !t.completed);
        } else if (this.currentFilter === 'completed') {
            filtered = filtered.filter(t => t.completed);
        }

        return this.sortTasks(filtered);
    },

    render() {
        const filtered = this.getFilteredTasks();
        UIManager.renderTasks(filtered);
    }
};

// 初始化应用
document.addEventListener('DOMContentLoaded', () => {
    TodoApp.init();
});
```

## 关键要点

1. **数据模型** - 使用类封装任务逻辑
2. **本地存储** - 持久化任务数据
3. **事件委托** - 高效处理动态元素
4. **状态管理** - 集中管理应用状态
5. **用户反馈** - 提供即时的视觉反馈

## 下一步

👉 **[模块 5: 后端服务器搭建](./05-后端搭建.md)** - 构建 API 服务器

---

📚 **返回**: [第六课概述](./index.md)
