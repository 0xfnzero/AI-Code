# 模块 7: 功能增强

> 添加高级功能和优化

## 学习目标

- 实现搜索和过滤功能
- 添加排序功能
- 优化性能
- 改进用户体验
- 添加数据验证

## 1. 高级搜索

```javascript
const SearchManager = {
    search(tasks, query) {
        const lowerQuery = query.toLowerCase();
        return tasks.filter(task => 
            task.title.toLowerCase().includes(lowerQuery) ||
            task.description.toLowerCase().includes(lowerQuery) ||
            task.category.toLowerCase().includes(lowerQuery)
        );
    },

    filterByCategory(tasks, category) {
        return tasks.filter(task => task.category === category);
    },

    filterByStatus(tasks, completed) {
        return tasks.filter(task => task.completed === completed);
    },

    filterByPriority(tasks, priority) {
        return tasks.filter(task => task.priority === priority);
    },

    filterByDateRange(tasks, startDate, endDate) {
        return tasks.filter(task => {
            const taskDate = new Date(task.dueDate);
            return taskDate >= startDate && taskDate <= endDate;
        });
    }
};
```

## 2. 排序功能

```javascript
const SortManager = {
    byDate(tasks, ascending = true) {
        return tasks.sort((a, b) => {
            const dateA = new Date(a.createdAt);
            const dateB = new Date(b.createdAt);
            return ascending ? dateA - dateB : dateB - dateA;
        });
    },

    byPriority(tasks) {
        const priorityOrder = { high: 0, medium: 1, low: 2 };
        return tasks.sort((a, b) => 
            priorityOrder[a.priority] - priorityOrder[b.priority]
        );
    },

    byTitle(tasks) {
        return tasks.sort((a, b) => 
            a.title.localeCompare(b.title, 'zh-CN')
        );
    },

    byDueDate(tasks) {
        return tasks.sort((a, b) => {
            if (!a.dueDate) return 1;
            if (!b.dueDate) return -1;
            return new Date(a.dueDate) - new Date(b.dueDate);
        });
    }
};
```

## 3. 表单验证

```javascript
const ValidationManager = {
    validateTask(data) {
        const errors = [];

        if (!data.title || data.title.trim().length === 0) {
            errors.push('任务标题不能为空');
        }

        if (data.title && data.title.length > 100) {
            errors.push('任务标题不能超过100个字符');
        }

        if (data.description && data.description.length > 500) {
            errors.push('任务描述不能超过500个字符');
        }

        if (data.dueDate) {
            const dueDate = new Date(data.dueDate);
            if (dueDate < new Date()) {
                errors.push('到期日期不能早于当前日期');
            }
        }

        return {
            valid: errors.length === 0,
            errors
        };
    },

    sanitizeInput(input) {
        return input.trim()
            .replace(/[<>]/g, '')
            .replace(/javascript:/gi, '');
    }
};
```

## 4. 性能优化

```javascript
// 防抖函数
function debounce(func, delay) {
    let timeoutId;
    return function(...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(this, args), delay);
    };
}

// 节流函数
function throttle(func, limit) {
    let inThrottle;
    return function(...args) {
        if (!inThrottle) {
            func.apply(this, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
        }
    };
}

// 使用示例
const debouncedSearch = debounce((query) => {
    TodoApp.searchTasks(query);
}, 300);

document.getElementById('searchInput').addEventListener('input', (e) => {
    debouncedSearch(e.target.value);
});
```

## 5. 用户体验增强

```javascript
// 加载状态
function showLoading() {
    document.getElementById('loading').style.display = 'block';
}

function hideLoading() {
    document.getElementById('loading').style.display = 'none';
}

// 通知系统
const NotificationManager = {
    show(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.classList.add('show');
        }, 10);
        
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    },

    success(message) {
        this.show(message, 'success');
    },

    error(message) {
        this.show(message, 'error');
    },

    info(message) {
        this.show(message, 'info');
    }
};
```

## 6. 批量操作

```javascript
const BatchOperations = {
    selectedTasks: new Set(),

    selectTask(id) {
        this.selectedTasks.add(id);
    },

    deselectTask(id) {
        this.selectedTasks.delete(id);
    },

    selectAll(tasks) {
        tasks.forEach(task => this.selectedTasks.add(task.id));
    },

    deselectAll() {
        this.selectedTasks.clear();
    },

    deleteSelected() {
        this.selectedTasks.forEach(id => {
            StorageManager.deleteTask(id);
        });
        this.selectedTasks.clear();
        TodoApp.render();
        NotificationManager.success('已删除选中的任务');
    },

    completeSelected() {
        this.selectedTasks.forEach(id => {
            const task = TodoApp.tasks.find(t => t.id === id);
            if (task) {
                task.completed = true;
                StorageManager.saveTasks(TodoApp.tasks);
            }
        });
        this.selectedTasks.clear();
        TodoApp.render();
        NotificationManager.success('已完成选中的任务');
    }
};
```

## 关键要点

1. **搜索优化** - 使用防抖提升性能
2. **数据验证** - 确保数据完整性
3. **用户反馈** - 提供即时通知
4. **批量操作** - 提高操作效率
5. **性能优化** - 减少不必要的渲染

## 下一步

👉 **[模块 8: 部署上线](./08-部署上线.md)** - 将应用部署到生产环境

---

📚 **返回**: [第六课概述](./index.md)
