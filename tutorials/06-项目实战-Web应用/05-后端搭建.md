# 模块 5: 后端服务器搭建

> 使用 Node.js 和 Express 构建 RESTful API

## 学习目标

完成本模块后,你将能够:
- 搭建 Express.js 服务器
- 设计 RESTful API 路由
- 集成 SQLite 数据库
- 创建数据模型
- 处理 API 请求和响应

## 概述

在本模块中,我们将为 Todo App Pro 构建后端服务器。我们将创建处理任务管理的 RESTful API 并集成 SQLite 数据库。

## 1. Express 服务器设置

**server/index.js**:
```javascript
require('dotenv').config();
const express = require('express');
const cors = require('cors');
const path = require('path');

const app = express();
const PORT = process.env.PORT || 3000;

// 中间件
app.use(cors({
    origin: process.env.CLIENT_URL || 'http://localhost:5500',
    credentials: true
}));
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(express.static(path.join(__dirname, '../client')));

// 请求日志
app.use((req, res, next) => {
    console.log(`${new Date().toISOString()} - ${req.method} ${req.path}`);
    next();
});

// 健康检查
app.get('/api/health', (req, res) => {
    res.json({
        status: 'OK',
        message: '服务器运行正常',
        timestamp: new Date().toISOString()
    });
});

// 导入路由
const taskRoutes = require('./routes/tasks');
const authRoutes = require('./routes/auth');

// 使用路由
app.use('/api/tasks', taskRoutes);
app.use('/api/auth', authRoutes);

// 错误处理
app.use((err, req, res, next) => {
    console.error('错误:', err);
    res.status(err.status || 500).json({
        error: {
            message: err.message || '内部服务器错误',
            status: err.status || 500
        }
    });
});

// 404 处理
app.use((req, res) => {
    res.status(404).json({
        error: { message: '路由未找到', status: 404 }
    });
});

// 启动服务器
app.listen(PORT, () => {
    console.log(`
🚀 服务器运行中!
📡 API: http://localhost:${PORT}/api
🌐 前端: http://localhost:${PORT}
📊 健康检查: http://localhost:${PORT}/api/health
    `);
});

module.exports = app;
```

## 2. 数据库设置

**server/database.js**:
```javascript
const Database = require('better-sqlite3');
const path = require('path');

const dbPath = process.env.DB_PATH || path.join(__dirname, '../database/tasks.db');
const db = new Database(dbPath);

db.pragma('foreign_keys = ON');

function initializeDatabase() {
    // 用户表
    db.exec(`
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT UNIQUE NOT NULL,
            email TEXT UNIQUE NOT NULL,
            password_hash TEXT NOT NULL,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )
    `);

    // 任务表
    db.exec(`
        CREATE TABLE IF NOT EXISTS tasks (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER NOT NULL,
            title TEXT NOT NULL,
            description TEXT,
            due_date TEXT,
            priority TEXT DEFAULT 'medium',
            category TEXT DEFAULT 'personal',
            completed BOOLEAN DEFAULT 0,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
        )
    `);

    console.log('✅ 数据库初始化完成');
}

initializeDatabase();

module.exports = db;
```

## 3. 任务路由

**server/routes/tasks.js**:
```javascript
const express = require('express');
const router = express.Router();
const db = require('../database');

// 获取所有任务
router.get('/', (req, res) => {
    try {
        const { category, completed, priority } = req.query;
        let query = 'SELECT * FROM tasks WHERE 1=1';
        const params = [];

        if (category) {
            query += ' AND category = ?';
            params.push(category);
        }

        if (completed !== undefined) {
            query += ' AND completed = ?';
            params.push(completed === 'true' ? 1 : 0);
        }

        if (priority) {
            query += ' AND priority = ?';
            params.push(priority);
        }

        query += ' ORDER BY created_at DESC';

        const tasks = db.prepare(query).all(...params);
        res.json({ success: true, data: tasks });
    } catch (error) {
        res.status(500).json({ success: false, error: error.message });
    }
});

// 创建任务
router.post('/', (req, res) => {
    try {
        const { title, description, dueDate, priority, category } = req.body;

        if (!title) {
            return res.status(400).json({
                success: false,
                error: '任务标题是必需的'
            });
        }

        const stmt = db.prepare(`
            INSERT INTO tasks (user_id, title, description, due_date, priority, category)
            VALUES (1, ?, ?, ?, ?, ?)
        `);

        const result = stmt.run(title, description, dueDate, priority, category);
        const task = db.prepare('SELECT * FROM tasks WHERE id = ?').get(result.lastInsertRowid);

        res.status(201).json({ success: true, data: task });
    } catch (error) {
        res.status(500).json({ success: false, error: error.message });
    }
});

// 更新任务
router.put('/:id', (req, res) => {
    try {
        const { id } = req.params;
        const { title, description, dueDate, priority, category, completed } = req.body;

        const stmt = db.prepare(`
            UPDATE tasks
            SET title = COALESCE(?, title),
                description = COALESCE(?, description),
                due_date = COALESCE(?, due_date),
                priority = COALESCE(?, priority),
                category = COALESCE(?, category),
                completed = COALESCE(?, completed),
                updated_at = CURRENT_TIMESTAMP
            WHERE id = ?
        `);

        stmt.run(title, description, dueDate, priority, category, completed, id);
        const task = db.prepare('SELECT * FROM tasks WHERE id = ?').get(id);

        res.json({ success: true, data: task });
    } catch (error) {
        res.status(500).json({ success: false, error: error.message });
    }
});

// 删除任务
router.delete('/:id', (req, res) => {
    try {
        const { id } = req.params;
        const stmt = db.prepare('DELETE FROM tasks WHERE id = ?');
        const result = stmt.run(id);

        if (result.changes === 0) {
            return res.status(404).json({
                success: false,
                error: '任务未找到'
            });
        }

        res.json({ success: true, message: '任务已删除' });
    } catch (error) {
        res.status(500).json({ success: false, error: error.message });
    }
});

module.exports = router;
```

## 4. API 客户端

**client/js/api.js**:
```javascript
const API = {
    baseURL: 'http://localhost:3000/api',

    async request(endpoint, options = {}) {
        const url = `${this.baseURL}${endpoint}`;
        const config = {
            headers: {
                'Content-Type': 'application/json',
                ...options.headers
            },
            ...options
        };

        try {
            const response = await fetch(url, config);
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error?.message || '请求失败');
            }

            return data;
        } catch (error) {
            console.error('API 错误:', error);
            throw error;
        }
    },

    // 任务相关
    async getTasks(filters = {}) {
        const params = new URLSearchParams(filters);
        return this.request(`/tasks?${params}`);
    },

    async createTask(taskData) {
        return this.request('/tasks', {
            method: 'POST',
            body: JSON.stringify(taskData)
        });
    },

    async updateTask(id, updates) {
        return this.request(`/tasks/${id}`, {
            method: 'PUT',
            body: JSON.stringify(updates)
        });
    },

    async deleteTask(id) {
        return this.request(`/tasks/${id}`, {
            method: 'DELETE'
        });
    }
};
```

## 关键要点

1. **RESTful API** - 遵循 REST 设计原则
2. **数据库集成** - 使用 SQLite 持久化数据
3. **错误处理** - 统一的错误处理机制
4. **API 客户端** - 前端封装 API 调用
5. **安全性** - 输入验证和错误处理

## 下一步

👉 **[模块 6: 用户认证](./06-用户认证.md)** - 实现用户登录注册

---

📚 **返回**: [第六课概述](./index.md)
