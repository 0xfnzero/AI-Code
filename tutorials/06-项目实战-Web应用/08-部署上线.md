# 模块 8: 部署上线

> 将应用部署到生产环境

## 学习目标

- 准备生产环境构建
- 配置环境变量
- 部署到云平台
- 设置域名和 HTTPS
- 监控和维护

## 1. 生产环境准备

### 环境配置

**.env.production**:
```
NODE_ENV=production
PORT=3000
DB_PATH=/var/data/tasks.db
JWT_SECRET=your-secure-production-secret
CLIENT_URL=https://yourdomain.com
```

### package.json 脚本

```json
{
  "scripts": {
    "start": "NODE_ENV=production node server/index.js",
    "dev": "nodemon server/index.js",
    "build": "npm install --production",
    "test": "jest"
  }
}
```

## 2. 部署到 Heroku

### 步骤 1: 安装 Heroku CLI

```bash
# macOS
brew install heroku/brew/heroku

# Windows
# 下载并安装 Heroku CLI
```

### 步骤 2: 创建应用

```bash
# 登录 Heroku
heroku login

# 创建应用
heroku create your-app-name

# 设置环境变量
heroku config:set JWT_SECRET=your-secret
heroku config:set NODE_ENV=production
```

### 步骤 3: 部署

```bash
# 推送到 Heroku
git push heroku main

# 查看日志
heroku logs --tail

# 打开应用
heroku open
```

## 3. 部署到 Vercel

### vercel.json

```json
{
  "version": 2,
  "builds": [
    {
      "src": "server/index.js",
      "use": "@vercel/node"
    }
  ],
  "routes": [
    {
      "src": "/api/(.*)",
      "dest": "server/index.js"
    },
    {
      "src": "/(.*)",
      "dest": "/client/$1"
    }
  ]
}
```

### 部署命令

```bash
# 安装 Vercel CLI
npm i -g vercel

# 登录
vercel login

# 部署
vercel

# 部署到生产环境
vercel --prod
```

## 4. 部署到自己的服务器

### 使用 PM2

```bash
# 安装 PM2
npm install -g pm2

# 启动应用
pm2 start server/index.js --name "todo-app"

# 查看状态
pm2 status

# 查看日志
pm2 logs

# 重启
pm2 restart todo-app

# 开机自启动
pm2 startup
pm2 save
```

### Nginx 配置

```nginx
server {
    listen 80;
    server_name yourdomain.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

## 5. HTTPS 配置

### 使用 Let's Encrypt

```bash
# 安装 Certbot
sudo apt-get install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d yourdomain.com

# 自动续期
sudo certbot renew --dry-run
```

## 6. 性能优化

### Gzip 压缩

```javascript
const compression = require('compression');
app.use(compression());
```

### 静态资源缓存

```javascript
app.use(express.static('client', {
    maxAge: '1d',
    etag: true
}));
```

## 7. 监控和日志

### 使用 Winston

```javascript
const winston = require('winston');

const logger = winston.createLogger({
    level: 'info',
    format: winston.format.json(),
    transports: [
        new winston.transports.File({ filename: 'error.log', level: 'error' }),
        new winston.transports.File({ filename: 'combined.log' })
    ]
});

if (process.env.NODE_ENV !== 'production') {
    logger.add(new winston.transports.Console({
        format: winston.format.simple()
    }));
}
```

## 8. 数据库备份

```bash
# 备份脚本
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
sqlite3 /var/data/tasks.db ".backup /backups/tasks_$DATE.db"

# 保留最近7天的备份
find /backups -name "tasks_*.db" -mtime +7 -delete

# 添加到 crontab
# 每天凌晨2点备份
0 2 * * * /path/to/backup.sh
```

## 关键要点

1. **环境配置** - 正确设置生产环境变量
2. **部署选项** - 选择适合的托管平台
3. **HTTPS** - 启用安全连接
4. **监控** - 实时监控应用状态
5. **备份** - 定期备份数据库

## 项目完成检查清单

```
✅ 所有功能正常工作
✅ 通过所有测试
✅ 代码已审查和优化
✅ 文档已完成
✅ 环境变量已配置
✅ HTTPS 已启用
✅ 监控已设置
✅ 备份策略已实施
✅ 性能优化已完成
✅ 安全检查已通过
```

## 恭喜!

你已经完成了完整的 Web 应用开发流程,从规划到部署。这个项目展示了:

- 前端开发技能
- 后端 API 设计
- 数据库集成
- 用户认证
- 部署和运维

继续学习更多高级主题!

---

📚 **返回**: [第六课概述](./index.md)
